<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ã‚´ãƒ«ãƒ•ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ ã‚¹ã‚³ã‚¢</title>
<meta name="description" content="ã‚´ãƒ«ãƒ•ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯å½¢å¼ã®ã‚¹ã‚³ã‚¢ç®¡ç†ã‚¢ãƒ—ãƒª">
<meta name="theme-color" content="#16a34a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Golf Olympic">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="icon.svg">
<link rel="apple-touch-icon" href="icon.svg">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(to bottom,#f0fdf4,#dbeafe);min-height:100vh;padding-bottom:120px}
.container{max-width:1024px;margin:0 auto;padding:16px}
.card{background:white;border-radius:24px;padding:24px;margin-bottom:24px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
h1{font-size:24px;font-weight:bold;text-align:center;margin-bottom:24px}
h2{font-size:20px;font-weight:bold;margin-bottom:16px}
.label{display:block;font-weight:bold;margin-bottom:12px}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.hole-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch}
.hole-row{display:flex;gap:8px;min-width:min-content;padding-bottom:4px}
.btn{border:none;padding:12px;border-radius:12px;font-weight:bold;cursor:pointer;font-size:16px;background:#f3f4f6}
.btn-hole{position:relative;min-width:60px;flex-shrink:0}
.btn-hole.active{background:#16a34a;color:white}
.dot{position:absolute;width:8px;height:8px;border-radius:50%}
.dot-top{top:4px;right:4px;background:#06b6d4}
.dot-bottom{bottom:4px;right:4px;background:#a855f7}
.btn-player{display:flex;align-items:center;gap:12px;padding:16px}
.btn-player.active{background:#2563eb;color:white}
.avatar{font-size:24px}
.btn-score{padding:0;position:relative;color:white;aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60px;font-size:11px}
.btn-score.selected{box-shadow:0 0 0 4px #16a34a}
.bg-yellow-400{background:#facc15}.bg-gray-300{background:#d1d5db}.bg-orange-600{background:#ea580c}.bg-gray-600{background:#4b5563}.bg-blue-400{background:#60a5fa}.bg-green-400{background:#4ade80}.bg-purple-400{background:#c084fc}.bg-yellow-700{background:#a16207}.bg-red-400{background:#f87171}.bg-amber-200{background:#fde68a}.bg-green-600{background:#16a34a}.bg-blue-300{background:#93c5fd}.bg-gray-400{background:#9ca3af}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center;font-size:14px}
th{background:#f3f4f6;font-weight:bold}
.bg-cyan-100{background:#cffafe}.bg-purple-100{background:#f3e8ff}.bg-green-100{background:#dcfce7;color:#166534}.bg-red-100{background:#fee2e2;color:#991b1b}.bg-blue-100{background:#dbeafe}.bg-yellow-100{background:#fef3c7}
td.clickable{cursor:pointer}
td.clickable:hover{background:#bfdbfe}
.nav{position:fixed;bottom:0;left:0;right:0;background:white;border-top:2px solid #e5e7eb;display:flex;justify-content:space-around;padding:20px 16px;z-index:99999;box-shadow:0 -2px 10px rgba(0,0,0,0.1)}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:4px;border:none;background:none;cursor:pointer;color:#9ca3af;padding:8px;min-width:80px}
.nav-btn.active{color:#16a34a}
.nav-btn svg{width:28px;height:28px}
.nav-btn span{font-size:13px;font-weight:600}
input,select{padding:12px;border:1px solid #e5e7eb;border-radius:8px;font-size:16px}
.input-full{width:100%}
.flex{display:flex}.flex-gap{gap:8px}.mb-6{margin-bottom:24px}.space-y{display:flex;flex-direction:column;gap:12px}
.bg-gray-50{background:#f9fafb;border-radius:24px;padding:24px}
.btn-primary{background:#2563eb;color:white;padding:14px 24px;border-radius:12px;border:none;cursor:pointer;font-weight:bold;font-size:16px}
.btn-secondary{background:#e5e7eb;color:#374151;padding:14px 24px;border-radius:12px;border:none;cursor:pointer;font-weight:bold;font-size:16px}
.btn-count{padding:12px 24px}.btn-count.active{background:#2563eb;color:white}
.btn-reset{background:#f97316;color:white;padding:16px;border-radius:16px;width:100%;border:none;cursor:pointer;font-weight:bold;font-size:16px}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:100000;padding:20px}
.modal-content{background:white;border-radius:24px;padding:24px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto}
.preset-item{background:#f3f4f6;padding:20px;border-radius:16px;margin-bottom:16px;border:2px solid #e5e7eb}
.preset-name{font-weight:bold;margin-bottom:12px;font-size:18px;color:#1f2937}
.preset-btns{display:flex;gap:12px;margin-top:12px}
.btn-load{background:#2563eb;color:white;padding:14px;border-radius:10px;border:none;cursor:pointer;font-weight:bold;flex:1;font-size:16px}
.btn-del{background:#ef4444;color:white;padding:14px;border-radius:10px;border:none;cursor:pointer;font-weight:bold;font-size:16px;min-width:80px}
.alert{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#16a34a;color:white;padding:20px 32px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:200000;font-weight:bold;font-size:18px;max-width:90%;text-align:center}
.overflow-x{overflow-x:auto}
.pull-indicator{position:fixed;top:0;left:50%;transform:translateX(-50%);padding:8px 16px;background:#16a34a;color:white;border-radius:0 0 8px 8px;font-size:12px;opacity:0;pointer-events:none;transition:opacity 0.3s;z-index:9999}
.pull-indicator.active{opacity:1}
</style>
</head>
<body>
<div id="app"></div>
<!-- Firebase v8 SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>
// FirebaseåˆæœŸåŒ–ï¼ˆSDKã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤ï¼‰
function initFirebase() {
  if (typeof firebase === 'undefined') {
    console.log('Waiting for Firebase SDK...');
    setTimeout(initFirebase, 100);
    return;
  }
  
  // Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyCFD2IFYU34YK6Z_PRs2pTuZ-WZIj9Vy6M",
    authDomain: "golf-olympic.firebaseapp.com",
    databaseURL: "https://golf-olympic-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "golf-olympic",
    storageBucket: "golf-olympic.firebasestorage.app",
    messagingSenderId: "631997493044",
    appId: "1:631997493044:web:0a3f55657ac942d9fdff61"
  };

  // FirebaseåˆæœŸåŒ–
  firebase.initializeApp(firebaseConfig);
  window.database = firebase.database();
  window.auth = firebase.auth();
  window.googleProvider = new firebase.auth.GoogleAuthProvider();
  // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠã‚’å¼·åˆ¶ï¼ˆæ¯å›é¸æŠç”»é¢ã‚’è¡¨ç¤ºï¼‰
  window.googleProvider.setCustomParameters({
    prompt: 'select_account'
  });

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆv8 compat APIã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
  window.fbDB = {
    ref: (path) => window.database.ref(path),
    _db: window.database,
    _onValue: (ref, callback, errorCallback) => ref.on('value', callback, errorCallback),
    _off: (ref) => ref.off()
  };
  window.firebaseReady = true;

  console.log('âœ… Firebase v8 initialized');
  console.log('window.fbDB:', window.fbDB);
  console.log('window.firebaseReady:', window.firebaseReady);
  
  // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–ã‚’é–‹å§‹
  window.auth.onAuthStateChanged(async (user) => {
    if(user){
      D.user = user;
      D.isAuthenticated = true;
      console.log('ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­:', user.email);
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆå›ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã€authorized_usersã«è‡ªå‹•ç™»éŒ²
      await ensureUserRegistered(user);
      
      checkUserAuthorization(user);
    }else{
      D.user = null;
      D.isAuthenticated = false;
      D.isAuthorized = false;
      console.log('ğŸ‘¤ æœªãƒ­ã‚°ã‚¤ãƒ³');
      render();
    }
  });
}

// FirebaseåˆæœŸåŒ–ã‚’é–‹å§‹
initFirebase();

let D={hole:1,player:1,scores:{},view:'input',nph:{},dch:{},rid:null,isJoinedRound:false,cfg:{courseName:'',date:new Date().toISOString().split('T')[0],cnt:4,names:['P1','P2','P3','P4'],avs:['ğŸ‘¨','ğŸ‘©','ğŸ‘¨â€ğŸ’¼','ğŸ‘©â€ğŸ’¼'],pts:{gold:3,silver:2,bronze:1,iron:0,diamond:5,nearpin:1,dracon:1,eagle:3,birdie:1,sand:-1,flag:1,threeputt:-1},nikaiNearpin:false,nikaiDracon:false},showPresets:false,showSaveForm:false,showRounds:false,showRoundIdInput:false,showAvatarPicker:false,showFirebaseManager:false,showUserManager:false,showHowToUse:false,avatarPickerIndex:null,alert:null,debugLog:[],firebaseRounds:[],userList:[],adminMode:false,user:null,isAuthenticated:false,isAuthorized:false};
// ãƒ©ã‚¦ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥
let roundCache = {};
// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
function log(msg){
  const time = new Date().toLocaleTimeString('ja-JP');
  const logMsg = `[${time}] ${msg}`;
  D.debugLog.unshift(logMsg);
  if(D.debugLog.length > 20) D.debugLog.pop();
  console.log(logMsg);
  render();
}
const AVATARS=['ğŸ‘¨','ğŸ‘©','ğŸ‘¦','ğŸ‘§','ğŸ‘´','ğŸ‘µ','ğŸ‘¶','ğŸ§’','ğŸ§‘','ğŸ‘¨â€ğŸ’¼','ğŸ‘©â€ğŸ’¼','ğŸ‘¨â€âš•ï¸','ğŸ‘©â€âš•ï¸','ğŸ‘¨â€ğŸ“','ğŸ‘©â€ğŸ“','ğŸ‘¨â€ğŸ«','ğŸ‘©â€ğŸ«','ğŸ‘¨â€âš–ï¸','ğŸ‘©â€âš–ï¸','ğŸ‘¨â€ğŸŒ¾','ğŸ‘©â€ğŸŒ¾','ğŸ§”','ğŸ¤µ','ğŸ‘°','ğŸ…','ğŸ¤¶','ğŸ¦¸','ğŸ¦¹','â›³','ğŸŒï¸'];
// 128bit (16ãƒã‚¤ãƒˆ) ã®ãƒ©ãƒ³ãƒ€ãƒ IDã‚’ç”Ÿæˆ
function generateSecureRoundId(){
  const array = new Uint8Array(16); // 128bit = 16ãƒã‚¤ãƒˆ
  crypto.getRandomValues(array);
  // Base64URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆURLã‚»ãƒ¼ãƒ•ãªæ–‡å­—åˆ—ã«å¤‰æ›ï¼‰
  const base64 = btoa(String.fromCharCode(...array))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, ''); // ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°å‰Šé™¤
  return 'round_' + base64;
}
function newRound(){
  if(!D.isAuthorized){
    alert('âš ï¸ ãƒ©ã‚¦ãƒ³ãƒ‰ä½œæˆæ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“\n\né–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯ç®¡ç†è€…ã«æ‰¿èªã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  cacheCurrentRound();
  D.rid=generateSecureRoundId();
  D.scores={};
  D.isJoinedRound=false;
  localStorage.setItem('last_round_id', D.rid);
  console.log('æ–°è¦ãƒ©ã‚¦ãƒ³ãƒ‰ä½œæˆ:',D.rid);
  saveRound();
  startRealtimeSync();
  alert('âœ… æ–°è¦ãƒ©ã‚¦ãƒ³ãƒ‰ä½œæˆ\n\nãƒ©ã‚¦ãƒ³ãƒ‰IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨å…±æœ‰ã—ã¦ãã ã•ã„');
}
async function joinRound(){
  const rid=document.getElementById('roundIdInput').value.trim();
  if(!rid){alert('âŒ ãƒ©ã‚¦ãƒ³ãƒ‰IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  
  log('å‚åŠ é–‹å§‹: ' + rid);
  
  // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
  if(!window.firebaseReady || !window.fbDB){
    log('âŒ FirebaseæœªåˆæœŸåŒ– ready:' + window.firebaseReady);
    alert('âŒ FirebaseåˆæœŸåŒ–ä¸­ã§ã™\n\næ•°ç§’å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„');
    return;
  }
  
  log('âœ… Firebase OK');
  
  // ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  cacheCurrentRound();
  
  try{
    const dbRef = window.fbDB.ref('rounds/'+rid);
    log('Firebaseèª­ã¿è¾¼ã¿é–‹å§‹');
    
    // onValueã‚’ä½¿ã£ã¦ä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€
    let unsubscribe = null;
    const data = await new Promise((resolve, reject) => {
      try {
        unsubscribe = window.fbDB._onValue(dbRef, (snapshot) => {
          try {
            log('Snapshotå–å¾—: ' + (snapshot && snapshot.val() ? 'ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š' : 'ãƒ‡ãƒ¼ã‚¿ãªã—'));
            resolve(snapshot ? snapshot.val() : null);
          } catch (e) {
            log('âŒ Snapshotå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e.message);
            reject(e);
          }
        }, (error) => {
          log('âŒ Firebaseèª­è¾¼ã‚¨ãƒ©ãƒ¼: ' + error.message);
          reject(error);
        });
      } catch (e) {
        log('âŒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message);
        reject(e);
      }
    });
    
    // ãƒªã‚¹ãƒŠãƒ¼ã‚’å³åº§ã«è§£é™¤
    if(unsubscribe) unsubscribe();
    
    if(data){
      log('âœ… ãƒ‡ãƒ¼ã‚¿èª­è¾¼æˆåŠŸ');
      D.rid=rid;
      D.isJoinedRound=true;
      D.cfg=data.cfg||D.cfg;
      D.scores=data.scores||{};
      D.nph=data.nph||{};
      D.dch=data.dch||{};
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚‚ä¿å­˜
      cacheCurrentRound();
      
      const list=JSON.parse(localStorage.getItem('rounds_list')||'[]');
      const exists=list.find(x=>x.id===rid);
      if(!exists){
        list.unshift({id:rid,courseName:D.cfg.courseName||'æœªè¨­å®š',date:D.cfg.date,updatedAt:data.updatedAt||Date.now(),isJoined:true});
        localStorage.setItem('rounds_list',JSON.stringify(list));
      }
      D.showRoundIdInput=false;
      startRealtimeSync();
      log('âœ… å‚åŠ å®Œäº†');
      alert('âœ… ãƒ©ã‚¦ãƒ³ãƒ‰ã«å‚åŠ ã—ã¾ã—ãŸ\n\nã‚¹ã‚³ã‚¢ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åŒæœŸã•ã‚Œã¾ã™');
      render();
    }else{
      log('âŒ ãƒ©ã‚¦ãƒ³ãƒ‰æœªç™ºè¦‹: ' + rid);
      alert('âŒ ãƒ©ã‚¦ãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: '+rid);
    }
  }catch(err){
    log('âŒ ã‚¨ãƒ©ãƒ¼: ' + err.message);
    alert('âŒ ã‚¨ãƒ©ãƒ¼: '+err.message);
  }
}
let realtimeListener=null;
function startRealtimeSync(){
  if(realtimeListener){
    // v9ã§ã¯ç›´æ¥off()ã¯ä½¿ãˆãªã„ã®ã§ã€unsubscribeé–¢æ•°ã‚’å‘¼ã¶
    if(typeof realtimeListener === 'function') realtimeListener();
  }
  if(!D.rid || !window.firebaseReady || !window.fbDB){
    console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã‚¹ã‚­ãƒƒãƒ— - FirebaseæœªåˆæœŸåŒ–ã¾ãŸã¯ridãªã—');
    return;
  }
  const dbRef = window.fbDB.ref('rounds/'+D.rid);
  realtimeListener = window.fbDB._onValue(dbRef, (snapshot)=>{
    const data=snapshot.val();
    if(data){
      console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°:',data);
      const oldScores=JSON.stringify(D.scores);
      D.cfg=data.cfg||D.cfg;
      D.scores=data.scores||{};
      D.nph=data.nph||{};
      D.dch=data.dch||{};
      if(JSON.stringify(D.scores)!==oldScores){
        console.log('ã‚¹ã‚³ã‚¢å¤‰æ›´æ¤œçŸ¥');
        render();
      }
    }
  });
}
function stopRealtimeSync(){if(realtimeListener && typeof realtimeListener === 'function'){realtimeListener();realtimeListener=null}}
async function saveRound(){
  if(!D.rid){console.log('ã‚¨ãƒ©ãƒ¼: ridãŒnull');return}
  const r={
    id:D.rid,
    courseName:D.cfg.courseName,
    date:D.cfg.date,
    players:D.cfg.names.slice(0,D.cfg.cnt),
    cfg:D.cfg,
    scores:JSON.parse(JSON.stringify(D.scores)),
    nph:D.nph,
    dch:D.dch,
    updatedAt:Date.now()
  };
  console.log('ãƒ©ã‚¦ãƒ³ãƒ‰ä¿å­˜:',r);
  
  // Firebase Realtime Database ã«ä¿å­˜
  if(window.firebaseReady && window.fbDB){
    try{
      const dbRef = window.fbDB.ref('rounds/' + D.rid);
      await dbRef.set(r);
      console.log('Firebaseä¿å­˜å®Œäº†');
    }catch(err){
      console.log('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:',err);
    }
  } else {
    console.log('FirebaseæœªåˆæœŸåŒ– - LocalStorageã®ã¿ä¿å­˜');
  }
  
  // LocalStorage ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  localStorage.setItem(D.rid,JSON.stringify(r));
  const list=JSON.parse(localStorage.getItem('rounds_list')||'[]');
  const idx=list.findIndex(x=>x.id===D.rid);
  const item={id:D.rid,courseName:D.cfg.courseName||'æœªè¨­å®š',date:D.cfg.date,updatedAt:r.updatedAt};
  if(idx>-1)list[idx]=item;else list.unshift(item);
  localStorage.setItem('rounds_list',JSON.stringify(list));
  console.log('ãƒ©ã‚¦ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ:',list);
}
async function loadRound(id){
  console.log('ãƒ©ã‚¦ãƒ³ãƒ‰èª­è¾¼é–‹å§‹:',id);
  if(!id){console.log('ã‚¨ãƒ©ãƒ¼: idãŒç©º');return}
  
  // ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
  cacheCurrentRound();
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒã‚’è©¦ã¿ã‚‹
  if(loadFromCache(id)){
    D.rid=id;
    localStorage.setItem('last_round_id', id);
    startRealtimeSync();
    render();
    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰èª­è¾¼å®Œäº†');
    return;
  }
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãªã‘ã‚Œã°localStorageã‹ã‚‰
  let r=JSON.parse(localStorage.getItem(id));
  console.log('localStorageã‹ã‚‰èª­è¾¼:',r);
  if(!r){console.log('ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãªã—');return}
  
  D.rid=id;
  D.scores=r.scores||{};
  if(r.cfg){D.cfg=r.cfg}
  if(r.nph){D.nph=r.nph}
  if(r.dch){D.dch=r.dch}
  
  const list=JSON.parse(localStorage.getItem('rounds_list')||'[]');
  const roundInfo=list.find(x=>x.id===id);
  D.isJoinedRound=roundInfo&&roundInfo.isJoined?true:false;
  
  localStorage.setItem('last_round_id', id);
  console.log('èª­è¾¼å®Œäº† rid:',D.rid,'scores:',D.scores,'isJoined:',D.isJoinedRound);
  startRealtimeSync();
  render();
  alert('âœ… ãƒ©ã‚¦ãƒ³ãƒ‰èª­è¾¼');
}
async function deleteRound(id){console.log('ãƒ©ã‚¦ãƒ³ãƒ‰å‰Šé™¤:',id);if(D.apiUrl){try{const formData=new URLSearchParams();formData.append('action','deleteRound');formData.append('roundId',id);await fetch(D.apiUrl,{method:'POST',body:formData,mode:'no-cors'})}catch(err){console.log('Sheetså‰Šé™¤ã‚¨ãƒ©ãƒ¼:',err)}}localStorage.removeItem(id);const list=JSON.parse(localStorage.getItem('rounds_list')||'[]');localStorage.setItem('rounds_list',JSON.stringify(list.filter(x=>x.id!==id)));if(D.rid===id){newRound()}else{render()}alert('âœ… ãƒ©ã‚¦ãƒ³ãƒ‰å‰Šé™¤')}
async function syncFromSheets(){alert('âŒ Sheetsé€£æºã¯ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚èª­è¾¼æ©Ÿèƒ½ã¯ä»Šå¾Œè¿½åŠ äºˆå®šã§ã™ã€‚')}
const T=[{id:'gold',l:'é‡‘',c:'bg-yellow-400',g:'rank',icon:'ğŸ¥‡'},{id:'silver',l:'éŠ€',c:'bg-gray-300',g:'rank',icon:'ğŸ¥ˆ'},{id:'bronze',l:'éŠ…',c:'bg-orange-600',g:'rank',icon:'ğŸ¥‰'},{id:'iron',l:'é‰„',c:'bg-gray-600',g:'rank',icon:'âš«'},{id:'diamond',l:'ãƒ€ã‚¤ãƒ¤',c:'bg-blue-400',g:'rank',icon:'ğŸ’'},{id:'nearpin',l:'ãƒ‹ã‚¢ãƒ”ãƒ³',c:'bg-green-400',g:'special',icon:'ğŸ¯'},{id:'dracon',l:'ãƒ‰ãƒ©ã‚³ãƒ³',c:'bg-purple-400',g:'special',icon:'ğŸŒï¸'},{id:'eagle',l:'ã‚¤ãƒ¼ã‚°ãƒ«',c:'bg-yellow-700',g:'score',icon:'ğŸ¦…'},{id:'birdie',l:'ãƒãƒ¼ãƒ‡ã‚£ãƒ¼',c:'bg-red-400',g:'score',icon:'ğŸ¦'},{id:'sand',l:'ç ‚',c:'bg-amber-200',g:'other',icon:'â›±ï¸'},{id:'flag',l:'æ——',c:'bg-green-600',g:'other',icon:'ğŸš©'},{id:'threeputt',l:'3ãƒ‘ãƒƒãƒˆ',c:'bg-blue-300',g:'other',icon:'â›³'},{id:'none',l:'ãªã—',c:'bg-gray-400',g:'none',icon:'âŒ'}];
function alert(m){D.alert=m;render();setTimeout(()=>{D.alert=null;render()},3000)}
function save(){saveRound()}
async function loadFirebaseRounds(){
  if(!window.firebaseReady || !window.fbDB){
    log('âŒ FirebaseæœªåˆæœŸåŒ–');
    alert('FirebaseæœªåˆæœŸåŒ–ã§ã™');
    return;
  }
  
  log('Firebaseä¸€è¦§å–å¾—é–‹å§‹');
  try{
    const dbRef = window.fbDB.ref('rounds');
    const snapshot = await new Promise((resolve, reject) => {
      window.fbDB._onValue(dbRef, (snap) => {
        log('Snapshotå–å¾—å®Œäº†');
        resolve(snap);
      }, (error) => {
        log('âŒ Snapshotå–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
        reject(error);
      });
    });
    
    const data = snapshot.val();
    log('å–å¾—ãƒ‡ãƒ¼ã‚¿: ' + (data ? Object.keys(data).length + 'ä»¶' : 'null'));
    
    if(data){
      D.firebaseRounds = Object.entries(data).map(([id, round]) => {
        log('å‡¦ç†ä¸­: ' + id);
        return {
          id,
          courseName: round.cfg?.courseName || 'æœªè¨­å®š',
          date: round.cfg?.date || '',
          updatedAt: round.updatedAt || 0,
          playerCount: Object.keys(round.scores || {}).length
        };
      }).sort((a,b) => b.updatedAt - a.updatedAt);
      log(`âœ… ${D.firebaseRounds.length}ä»¶å–å¾—å®Œäº†`);
    }else{
      D.firebaseRounds = [];
      log('ãƒ‡ãƒ¼ã‚¿ãªã—');
    }
    render();
  }catch(err){
    log('âŒ ã‚¨ãƒ©ãƒ¼: ' + err.message);
    alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
async function deleteFirebaseRound(id){
  // æœ€çµ‚ç¢ºèªã®ã¿
  if(!confirm(`ãƒ©ã‚¦ãƒ³ãƒ‰ ${id.substring(0, 25)}...\nã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å‚åŠ è€…å…¨å“¡ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚`)){
    return;
  }
  
  log('å‰Šé™¤é–‹å§‹: ' + id);
  try{
    const dbRef = window.fbDB.ref('rounds/' + id);
    await dbRef.set(null);
    log('âœ… å‰Šé™¤å®Œäº†: ' + id);
    alert('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');
    // ä¸€è¦§ã‚’å†èª­è¾¼
    await loadFirebaseRounds();
  }catch(err){
    log('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err.message);
    alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†é–¢æ•°
async function loadAllUsers(){
  if(!window.firebaseReady || !window.database){
    alert('FirebaseæœªåˆæœŸåŒ–ã§ã™');
    return;
  }
  
  console.log('ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—é–‹å§‹');
  try{
    const usersRef = window.database.ref('authorized_users');
    const snapshot = await usersRef.once('value');
    const data = snapshot.val();
    
    if(data){
      D.userList = Object.entries(data).map(([uid, userData]) => ({
        uid,
        email: userData.email || 'ä¸æ˜',
        authorized: userData.authorized === true,
        isAdmin: userData.isAdmin === true,
        addedAt: userData.addedAt || null
      })).sort((a,b) => {
        // ç®¡ç†è€… > æ‰¿èªæ¸ˆã¿ > æœªæ‰¿èª ã®é †
        if(a.isAdmin !== b.isAdmin) return a.isAdmin ? -1 : 1;
        if(a.authorized !== b.authorized) return a.authorized ? -1 : 1;
        return (b.addedAt || 0) - (a.addedAt || 0);
      });
      console.log(`âœ… ${D.userList.length}äººå–å¾—å®Œäº†`);
    }else{
      D.userList = [];
      console.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—');
    }
    render();
  }catch(err){
    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    alert('ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
async function approveUser(uid, email){
  if(!confirm(`${email}\nã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ\n\næ‰¿èªã™ã‚‹ã¨ã‚¹ã‚³ã‚¢å…¥åŠ›ãƒ»ãƒ©ã‚¦ãƒ³ãƒ‰ä½œæˆãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`)){
    return;
  }
  
  try{
    const userRef = window.database.ref(`authorized_users/${uid}`);
    await userRef.set({
      email: email,
      authorized: true,
      addedAt: Date.now()
    });
    console.log('âœ… æ‰¿èªå®Œäº†:', email);
    alert('âœ… æ‰¿èªã—ã¾ã—ãŸ');
    await loadAllUsers();
  }catch(err){
    console.error('âŒ æ‰¿èªã‚¨ãƒ©ãƒ¼:', err);
    alert('æ‰¿èªã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
async function revokeUser(uid, email){
  if(!confirm(`${email}\nã®æ‰¿èªã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n\né–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚Šã¾ã™ã€‚`)){
    return;
  }
  
  try{
    const userRef = window.database.ref(`authorized_users/${uid}/authorized`);
    await userRef.set(false);
    console.log('âœ… å´ä¸‹å®Œäº†:', email);
    alert('âœ… æ‰¿èªã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
    await loadAllUsers();
  }catch(err){
    console.error('âŒ å´ä¸‹ã‚¨ãƒ©ãƒ¼:', err);
    alert('å´ä¸‹ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
async function removeUser(uid, email){
  if(!confirm(`${email}\nã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)){
    return;
  }
  
  try{
    const userRef = window.database.ref(`authorized_users/${uid}`);
    await userRef.set(null);
    console.log('âœ… å‰Šé™¤å®Œäº†:', email);
    alert('âœ… å‰Šé™¤ã—ã¾ã—ãŸ');
    await loadAllUsers();
  }catch(err){
    console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
    alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
async function makeAdmin(uid, email){
  if(!confirm(`${email}\nã‚’ç®¡ç†è€…ã«ã—ã¾ã™ã‹ï¼Ÿ\n\nç®¡ç†è€…ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»Firebaseç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚`)){
    return;
  }
  
  try{
    const userRef = window.database.ref(`authorized_users/${uid}/isAdmin`);
    await userRef.set(true);
    console.log('âœ… ç®¡ç†è€…ä»˜ä¸å®Œäº†:', email);
    alert('âœ… ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã—ãŸ');
    await loadAllUsers();
  }catch(err){
    console.error('âŒ ç®¡ç†è€…ä»˜ä¸ã‚¨ãƒ©ãƒ¼:', err);
    alert('ç®¡ç†è€…ä»˜ä¸ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
async function removeAdmin(uid, email){
  if(!confirm(`${email}\nã®ç®¡ç†è€…æ¨©é™ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ»Firebaseç®¡ç†ãŒã§ããªããªã‚Šã¾ã™ã€‚`)){
    return;
  }
  
  try{
    const userRef = window.database.ref(`authorized_users/${uid}/isAdmin`);
    await userRef.set(null);
    console.log('âœ… ç®¡ç†è€…è§£é™¤å®Œäº†:', email);
    alert('âœ… ç®¡ç†è€…æ¨©é™ã‚’è§£é™¤ã—ã¾ã—ãŸ');
    await loadAllUsers();
  }catch(err){
    console.error('âŒ ç®¡ç†è€…è§£é™¤ã‚¨ãƒ©ãƒ¼:', err);
    alert('ç®¡ç†è€…è§£é™¤ã‚¨ãƒ©ãƒ¼: ' + err.message);
  }
}
function cacheCurrentRound(){
  if(!D.rid)return;
  roundCache[D.rid]={
    cfg:JSON.parse(JSON.stringify(D.cfg)),
    scores:JSON.parse(JSON.stringify(D.scores)),
    nph:JSON.parse(JSON.stringify(D.nph)),
    dch:JSON.parse(JSON.stringify(D.dch)),
    isJoinedRound:D.isJoinedRound
  };
  console.log('ãƒ©ã‚¦ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜:',D.rid);
}
function loadFromCache(rid){
  if(roundCache[rid]){
    console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ:',rid);
    D.cfg=JSON.parse(JSON.stringify(roundCache[rid].cfg));
    D.scores=JSON.parse(JSON.stringify(roundCache[rid].scores));
    D.nph=JSON.parse(JSON.stringify(roundCache[rid].nph));
    D.dch=JSON.parse(JSON.stringify(roundCache[rid].dch));
    D.isJoinedRound=roundCache[rid].isJoinedRound;
    return true;
  }
  return false;
}
const MEDALS=['gold','silver','bronze','iron'];
function isMedalTaken(hole,medal,currentPlayer){for(let p=1;p<=D.cfg.cnt;p++){if(p===currentPlayer)continue;const scores=D.scores['h'+hole+'_p'+p]||[];if(scores.includes(medal))return p}return false}
function rec(t){
  // æœªæ‰¿èªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ›¸ãè¾¼ã¿ä¸å¯
  if(!D.isAuthorized){
    alert('âš ï¸ ç·¨é›†æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“\n\né–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ã‚¹ã‚³ã‚¢ã‚’ç·¨é›†ã™ã‚‹ã«ã¯ç®¡ç†è€…ã«æ‰¿èªã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  const k='h'+D.hole+'_p'+D.player;if(!D.scores[k])D.scores[k]=[];const type=T.find(x=>x.id===t);if(t==='none')D.scores[k]=[];else if(type.g==='rank'){const takenBy=isMedalTaken(D.hole,t,D.player);if(takenBy){alert('âŒ '+type.l+'ã¯æ—¢ã«'+D.cfg.names[takenBy-1]+'ãŒç²å¾—ã—ã¦ã„ã¾ã™');return}D.scores[k]=D.scores[k].filter(x=>T.find(y=>y.id===x).g!=='rank');D.scores[k].push(t)}else if(type.g==='special'){D.scores[k]=D.scores[k].filter(x=>T.find(y=>y.id===x).g!=='special');D.scores[k].push(t)}else if(type.g==='score'){D.scores[k]=D.scores[k].filter(x=>T.find(y=>y.id===x).g!=='score');D.scores[k].push(t)}else{const i=D.scores[k].indexOf(t);i>-1?D.scores[k].splice(i,1):D.scores[k].push(t)}save();render()}
function raw(h,p){const k='h'+h+'_p'+p;const sc=D.scores[k]||[];let pts=0;sc.forEach(t=>{let baseP=D.cfg.pts[t]||0;pts+=baseP;if(t==='nearpin'&&D.cfg.nikaiNearpin){const isOut=h<=9;const start=isOut?1:10;let carryCount=0;for(let prev=h-1;prev>=start;prev--){if(D.nph[prev]){let prevHas=false;for(let pp=1;pp<=D.cfg.cnt;pp++){if((D.scores['h'+prev+'_p'+pp]||[]).includes('nearpin')){prevHas=true;break}}if(!prevHas)carryCount++;else break}}pts+=carryCount*baseP}if(t==='dracon'&&D.cfg.nikaiDracon){const isOut=h<=9;const start=isOut?1:10;let carryCount=0;for(let prev=h-1;prev>=start;prev--){if(D.dch[prev]){let prevHas=false;for(let pp=1;pp<=D.cfg.cnt;pp++){if((D.scores['h'+prev+'_p'+pp]||[]).includes('dracon')){prevHas=true;break}}if(!prevHas)carryCount++;else break}}pts+=carryCount*baseP}});return pts}
function calc(h,p){const my=raw(h,p);let tot=0;for(let i=1;i<=D.cfg.cnt;i++)tot+=raw(h,i);return my*D.cfg.cnt-tot}
function tOut(p){let s=0;for(let h=1;h<=9;h++)s+=calc(h,p);return s}
function tIn(p){let s=0;for(let h=10;h<=18;h++)s+=calc(h,p);return s}
function tAll(p){return tOut(p)+tIn(p)}
function selectAvatar(idx,avatar){D.cfg.avs[idx]=avatar;D.showAvatarPicker=false;D.avatarPickerIndex=null;save();render()}
function openAvatarPicker(idx){D.showAvatarPicker=true;D.avatarPickerIndex=idx;render()}
function selectAvatar(idx,avatar){D.cfg.avs[idx]=avatar;D.showAvatarPicker=false;D.avatarPickerIndex=null;save();render()}
function openAvatarPicker(idx){D.showAvatarPicker=true;D.avatarPickerIndex=idx;render()}
function rAvatarPicker(){return`<div class="modal" onclick="if(event.target===this){D.showAvatarPicker=false;D.avatarPickerIndex=null;render()}"><div class="modal-content" onclick="event.stopPropagation()"><h2>ğŸ‘¤ ã‚¢ãƒã‚¿ãƒ¼é¸æŠ</h2><div style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin:20px 0;max-height:60vh;overflow-y:auto">${AVATARS.map(a=>`<button class="btn" style="font-size:32px;padding:16px;background:${D.cfg.avs[D.avatarPickerIndex]===a?'#dbeafe':'white'};border:2px solid ${D.cfg.avs[D.avatarPickerIndex]===a?'#3b82f6':'#e5e7eb'}" onclick="selectAvatar(${D.avatarPickerIndex},'${a}')">${a}</button>`).join('')}</div><button class="btn-secondary" style="width:100%" onclick="D.showAvatarPicker=false;D.avatarPickerIndex=null;render()">âœ–ï¸ é–‰ã˜ã‚‹</button></div></div>`}
function rHowToUse(){return`<div class="modal" style="z-index:2000"><div style="position:fixed;top:0;left:0;right:0;bottom:0;background:white;overflow-y:auto;padding:20px"><div style="max-width:800px;margin:0 auto"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;position:sticky;top:0;background:white;padding:10px 0;border-bottom:2px solid #e5e7eb"><h1 style="margin:0;font-size:24px">ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h1><button onclick="D.showHowToUse=false;render()" style="background:#ef4444;color:white;border:none;font-size:24px;width:40px;height:40px;border-radius:8px;cursor:pointer;font-weight:bold">âœ•</button></div><div style="line-height:1.8;color:#374151"><h2 style="color:#16a34a;border-bottom:2px solid #16a34a;padding-bottom:8px">ğŸš€ ã¯ã˜ã‚ã«</h2><p><strong>ã‚¢ã‚¯ã‚»ã‚¹:</strong> <a href="https://guncys-inc.github.io/olympic_score/" target="_blank" style="color:#3b82f6">https://guncys-inc.github.io/olympic_score/</a></p><h3 style="color:#059669;margin-top:24px">ğŸ“± PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆæ¨å¥¨ï¼‰</h3><p><strong>iPhone/iPad:</strong> Safari â†’ å…±æœ‰ãƒœã‚¿ãƒ³ â†’ ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</p><p><strong>Android:</strong> Chrome â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ â†’ ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€</p><h2 style="color:#16a34a;border-bottom:2px solid #16a34a;padding-bottom:8px;margin-top:32px">ğŸ® åŸºæœ¬çš„ãªä½¿ã„æ–¹</h2><h3 style="color:#059669">1. ãƒ©ã‚¦ãƒ³ãƒ‰ã®é–‹å§‹</h3><p><strong>æ–°è¦ä½œæˆ:</strong></p><ol style="padding-left:24px;margin:8px 0"><li style="margin:4px 0">è¨­å®šç”»é¢ â†’ ğŸ†• æ–°è¦ä½œæˆ</li><li style="margin:4px 0">è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒ©ã‚¦ãƒ³ãƒ‰IDã‚’ã‚³ãƒ”ãƒ¼</li><li style="margin:4px 0">åŒä¼´ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«LINEã§å…±æœ‰</li></ol><p><strong>å‚åŠ :</strong></p><ol style="padding-left:24px;margin:8px 0"><li style="margin:4px 0">è¨­å®šç”»é¢ â†’ ğŸ”— å‚åŠ </li><li style="margin:4px 0">å…±æœ‰ã•ã‚ŒãŸãƒ©ã‚¦ãƒ³ãƒ‰IDã‚’å…¥åŠ›</li><li style="margin:4px 0">å‚åŠ ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</li></ol><h3 style="color:#059669">2. ã‚¹ã‚³ã‚¢å…¥åŠ›</h3><p><strong>ãƒ¡ãƒ€ãƒ«ï¼ˆãƒ©ãƒ³ã‚¯ç³»ãƒ»1ã¤ã®ã¿é¸æŠï¼‰:</strong></p><ul style="padding-left:24px;margin:8px 0"><li style="margin:4px 0">ğŸ¥‡ é‡‘ãƒ¡ãƒ€ãƒ«ï¼ˆ+3ç‚¹ï¼‰</li><li style="margin:4px 0">ğŸ¥ˆ éŠ€ãƒ¡ãƒ€ãƒ«ï¼ˆ+2ç‚¹ï¼‰</li><li style="margin:4px 0">ğŸ¥‰ éŠ…ãƒ¡ãƒ€ãƒ«ï¼ˆ+1ç‚¹ï¼‰</li><li style="margin:4px 0">âš« é‰„ãƒ¡ãƒ€ãƒ«ï¼ˆ0ç‚¹ï¼‰</li><li style="margin:4px 0">ğŸ’ ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ï¼ˆ+5ç‚¹ï¼‰</li></ul><p><strong>è¿½åŠ ã‚¹ã‚³ã‚¢ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰:</strong></p><ul style="padding-left:24px;margin:8px 0"><li style="margin:4px 0">ğŸ¯ ãƒ‹ã‚¢ãƒ”ãƒ³ï¼ˆ+1ç‚¹ï¼‰</li><li style="margin:4px 0">ğŸŒï¸ ãƒ‰ãƒ©ã‚³ãƒ³ï¼ˆ+1ç‚¹ï¼‰</li><li style="margin:4px 0">ğŸ¦… ã‚¤ãƒ¼ã‚°ãƒ«ï¼ˆ+3ç‚¹ï¼‰</li><li style="margin:4px 0">ğŸ¦ ãƒãƒ¼ãƒ‡ã‚£ãƒ¼ï¼ˆ+1ç‚¹ï¼‰</li><li style="margin:4px 0">â›³ æ——ã‚’ç«‹ã¦ãŸã¾ã¾ï¼ˆ+1ç‚¹ï¼‰</li><li style="margin:4px 0">ğŸ–ï¸ ãƒãƒ³ã‚«ãƒ¼ï¼ˆ-1ç‚¹ï¼‰</li><li style="margin:4px 0">âŒ 3ãƒ‘ãƒƒãƒˆï¼ˆ-1ç‚¹ï¼‰</li></ul><h3 style="color:#059669">3. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ</h3><p>ã‚¹ã‚³ã‚¢å…¥åŠ›å¾Œã€è‡ªå‹•çš„ã«Firebaseã«ä¿å­˜ã•ã‚Œã€åŒã˜ãƒ©ã‚¦ãƒ³ãƒ‰IDã®å…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p><h2 style="color:#16a34a;border-bottom:2px solid #16a34a;padding-bottom:8px;margin-top:32px">ğŸ“‚ ãƒ©ã‚¦ãƒ³ãƒ‰ç®¡ç†</h2><p>è¨­å®šç”»é¢ â†’ ğŸ“‚ ãƒ©ã‚¦ãƒ³ãƒ‰ç®¡ç†ã§éå»ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ç®¡ç†ã§ãã¾ã™ã€‚</p><p><strong>è¦–è¦šçš„åŒºåˆ¥:</strong></p><ul style="padding-left:24px;margin:8px 0"><li style="margin:4px 0">ğŸ”— <span style="color:#2563eb">é’è‰²</span>: å‚åŠ ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆä»–äººãŒä½œæˆï¼‰</li><li style="margin:4px 0">ğŸ“ <span style="color:#22c55e">ç·‘è‰²</span>: è‡ªåˆ†ã§ä½œæˆã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰</li></ul><h2 style="color:#16a34a;border-bottom:2px solid #16a34a;padding-bottom:8px;margin-top:32px">ğŸ’¡ Tips</h2><ul style="padding-left:24px;margin:8px 0"><li style="margin:4px 0"><strong>ã‚­ãƒ£ãƒªãƒ¼ã‚ªãƒ¼ãƒãƒ¼:</strong> è©²å½“è€…ãªã—ã®å›æ•°ã‚’ç´¯ç©ã—ã€æ¬¡ã«å–ã£ãŸäººãŒå…¨ã¦ç²å¾—</li><li style="margin:4px 0"><strong>ãƒ—ãƒªã‚»ãƒƒãƒˆ:</strong> ã‚ˆãä½¿ã†è¨­å®šã‚’ä¿å­˜ãƒ»å‘¼ã³å‡ºã—å¯èƒ½</li><li style="margin:4px 0"><strong>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³:</strong> LocalStorageã«ä¿å­˜ã•ã‚Œã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã«åŒæœŸ</li></ul><p style="margin-top:32px;padding:16px;background:#f0f9ff;border-radius:8px;text-align:center"><strong>æ¥½ã—ã„ã‚´ãƒ«ãƒ•ãƒ©ã‚¤ãƒ•ã‚’ï¼â›³âœ¨</strong></p></div></div></div>`}
function rLogin(){return`<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:9999"><div style="background:white;border-radius:16px;padding:40px;max-width:400px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center"><div style="font-size:64px;margin-bottom:16px">â›³</div><h1 style="color:#1f2937;margin-bottom:8px;font-size:28px">ã‚´ãƒ«ãƒ•ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯</h1><p style="color:#6b7280;margin-bottom:32px;font-size:14px">ã‚¹ã‚³ã‚¢ç®¡ç†ã‚¢ãƒ—ãƒª</p>${!D.isAuthenticated?`<button onclick="handleGoogleLogin()" style="width:100%;background:white;border:2px solid #e5e7eb;border-radius:8px;padding:16px;font-size:16px;font-weight:600;color:#1f2937;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:12px;transition:all 0.2s" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg><span>Googleã§ãƒ­ã‚°ã‚¤ãƒ³</span></button>`:D.isAuthenticated&&!D.isAuthorized?`<div style="background:#fef3c7;border:2px solid #fbbf24;border-radius:8px;padding:20px;margin-bottom:20px"><p style="color:#92400e;margin-bottom:12px;font-weight:600">âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“</p><p style="color:#92400e;font-size:14px;margin-bottom:4px">ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${D.user.email}</p><p style="color:#78716c;font-size:12px">ç®¡ç†è€…ã«æ‰¿èªã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„</p></div><button onclick="handleLogout()" style="width:100%;background:#ef4444;border:none;border-radius:8px;padding:12px;font-size:14px;font-weight:600;color:white;cursor:pointer">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>`:''}</div></div>`}
function savePreset(){D.showSaveForm=true;render()}
function savePresetSubmit(){const name=D.cfg.courseName||'æœªè¨­å®š';const date=D.cfg.date.replace(/-/g,'/');const presetName=name+' '+date;const id='p'+Date.now();localStorage.setItem(id,JSON.stringify({name:presetName,courseName:D.cfg.courseName,nph:D.nph,dch:D.dch,pts:D.cfg.pts}));const list=JSON.parse(localStorage.getItem('plist')||'[]');list.unshift({id,name:presetName});localStorage.setItem('plist',JSON.stringify(list));D.showSaveForm=false;alert('âœ… ä¿å­˜: '+presetName)}
function loadP(id){const p=JSON.parse(localStorage.getItem(id));if(!p){alert('âŒ ã‚¨ãƒ©ãƒ¼');return}D.cfg.courseName=p.courseName||'';D.nph=p.nph||{};D.dch=p.dch||{};D.cfg.pts=p.pts||D.cfg.pts;D.showPresets=false;save();alert('âœ… èª­è¾¼: '+p.name)}
function delP(id){localStorage.removeItem(id);const list=JSON.parse(localStorage.getItem('plist')||'[]');localStorage.setItem('plist',JSON.stringify(list.filter(x=>x.id!==id)));render();alert('âœ… å‰Šé™¤')}
function rInput(){const cur=D.scores['h'+D.hole+'_p'+D.player]||[];let details=[];let totalPts=0;if(cur.length>0){cur.forEach(t=>{const type=T.find(x=>x.id===t);if(!type)return;let baseP=D.cfg.pts[t]||0;let actualP=baseP;let note='';if(t==='nearpin'&&D.cfg.nikaiNearpin){const isOut=D.hole<=9;const start=isOut?1:10;let carryCount=0;let carryHoles=[];for(let prev=D.hole-1;prev>=start;prev--){if(D.nph[prev]){let prevHas=false;for(let pp=1;pp<=D.cfg.cnt;pp++){if((D.scores['h'+prev+'_p'+pp]||[]).includes('nearpin')){prevHas=true;break}}if(!prevHas){carryCount++;carryHoles.push(prev)}else break}}if(carryCount>0){actualP=baseP*(carryCount+1);note=' ('+carryHoles.reverse().join('H,')+'Hè©²å½“è€…ãªã—â†’'+(carryCount+1)+'å›åˆ†)'}else{actualP=baseP}}else if(t==='dracon'&&D.cfg.nikaiDracon){const isOut=D.hole<=9;const start=isOut?1:10;let carryCount=0;let carryHoles=[];for(let prev=D.hole-1;prev>=start;prev--){if(D.dch[prev]){let prevHas=false;for(let pp=1;pp<=D.cfg.cnt;pp++){if((D.scores['h'+prev+'_p'+pp]||[]).includes('dracon')){prevHas=true;break}}if(!prevHas){carryCount++;carryHoles.push(prev)}else break}}if(carryCount>0){actualP=baseP*(carryCount+1);note=' ('+carryHoles.reverse().join('H,')+'Hè©²å½“è€…ãªã—â†’'+(carryCount+1)+'å›åˆ†)'}else{actualP=baseP}}details.push({label:type.l,points:actualP,note:note});totalPts+=actualP})}return`<div class="container"><div class="card">${D.rid?`<div style="margin-bottom:16px;padding:12px;background:${D.isJoinedRound?'#dbeafe':'#dcfce7'};border-radius:8px;border:1px solid ${D.isJoinedRound?'#3b82f6':'#22c55e'}"><p style="font-size:11px;color:${D.isJoinedRound?'#1e40af':'#15803d'};margin-bottom:4px">${D.isJoinedRound?'ğŸ”—':'ğŸ“'} ${D.cfg.courseName||'ãƒ©ã‚¦ãƒ³ãƒ‰'}${D.isJoinedRound?' - å‚åŠ ä¸­':' - ä½œæˆè€…'}</p><div style="display:flex;gap:8px;align-items:center"><input readonly value="${D.rid}" style="flex:1;padding:8px;font-size:11px;font-family:monospace;background:white;border:1px solid ${D.isJoinedRound?'#93c5fd':'#86efac'};border-radius:6px" onclick="this.select()"><button class="btn-secondary" style="padding:8px 12px;font-size:11px" onclick="navigator.clipboard.writeText('${D.rid}');alert('âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')">ğŸ“‹</button></div></div>`:`<div style="margin-bottom:16px;padding:12px;background:#fef3c7;border-radius:8px;text-align:center"><p style="font-size:12px;color:#92400e">âš ï¸ ãƒ©ã‚¦ãƒ³ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</p><p style="font-size:11px;color:#92400e;margin-top:4px">è¨­å®šç”»é¢ã‹ã‚‰ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ä½œæˆã¾ãŸã¯å‚åŠ ã—ã¦ãã ã•ã„</p></div>`}<h1>${D.cfg.courseName||'ã‚´ãƒ«ãƒ•ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯'}</h1><div class="mb-6"><label class="label">ãƒ›ãƒ¼ãƒ«</label><div class="hole-scroll"><div class="hole-row">${[1,2,3,4,5,6,7,8,9].map(h=>`<button class="btn btn-hole ${D.hole===h?'active':''}" onclick="D.hole=${h};render()" style="background:${D.hole===h?'#16a34a':D.nph[h]?'#cffafe':D.dch[h]?'#f3e8ff':'#f3f4f6'};color:${D.hole===h?'white':'inherit'}">${h}${D.nph[h]?'<div class="dot dot-top"></div>':''}${D.dch[h]?'<div class="dot dot-bottom"></div>':''}</button>`).join('')}</div></div><div class="hole-scroll" style="margin-top:8px"><div class="hole-row">${[10,11,12,13,14,15,16,17,18].map(h=>`<button class="btn btn-hole ${D.hole===h?'active':''}" onclick="D.hole=${h};render()" style="background:${D.hole===h?'#16a34a':D.nph[h]?'#cffafe':D.dch[h]?'#f3e8ff':'#f3f4f6'};color:${D.hole===h?'white':'inherit'}">${h}${D.nph[h]?'<div class="dot dot-top"></div>':''}${D.dch[h]?'<div class="dot dot-bottom"></div>':''}</button>`).join('')}</div></div></div><div class="mb-6"><label class="label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</label><div class="grid-2">${[1,2,3,4].slice(0,D.cfg.cnt).map(p=>`<button class="btn btn-player ${D.player===p?'active':''}" onclick="D.player=${p};render()"><span class="avatar">${D.cfg.avs[p-1]}</span><span>${D.cfg.names[p-1]}</span></button>`).join('')}</div></div><div><label class="label">ã‚¹ã‚³ã‚¢</label><div class="grid-5">${T.map(t=>{const sel=cur.includes(t.id);let pts=D.cfg.pts[t.id]||0;return`<button class="btn btn-score ${t.c} ${sel?'selected':''}" onclick="rec('${t.id}')"><div style="font-size:20px;margin-bottom:2px">${t.icon||''}</div><div style="font-weight:bold;font-size:11px">${t.l}</div><div style="font-size:10px;margin-top:2px">${pts>0?'+':''}${pts}</div></button>`}).join('')}</div></div>${details.length>0?`<div style="margin-top:20px;padding:16px;background:#f0fdf4;border-radius:12px;border:2px solid #86efac"><h3 style="font-size:16px;font-weight:bold;margin-bottom:12px;color:#15803d">ğŸ“Š ${D.cfg.names[D.player-1]} - ${D.hole}H ç²å¾—ãƒã‚¤ãƒ³ãƒˆ</h3><div style="display:flex;flex-direction:column;gap:8px">${details.map(d=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:white;border-radius:8px"><span style="font-size:14px">${d.label}${d.note?'<span style="font-size:11px;color:#059669;margin-left:4px">'+d.note+'</span>':''}</span><span style="font-weight:bold;font-size:16px;color:${d.points>0?'#15803d':'#dc2626'}">${d.points>0?'+':''}${d.points}pt</span></div>`).join('')}</div><div style="margin-top:12px;padding:12px;background:#dcfce7;border-radius:8px;text-align:center"><span style="font-size:14px;color:#15803d">åˆè¨ˆï¼š</span><span style="font-weight:bold;font-size:20px;color:#15803d">${totalPts>0?'+':''}${totalPts}pt</span></div></div>`:'<div style="margin-top:20px;padding:16px;background:#f3f4f6;border-radius:12px;text-align:center;color:#6b7280"><p style="font-size:14px">ã‚¹ã‚³ã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</p></div>'}</div></div>`}
function rList(){return`<div class="container"><div class="card overflow-x"><h2>ã‚¹ã‚³ã‚¢ä¸€è¦§</h2><table><thead><tr><th>H</th>${[1,2,3,4].slice(0,D.cfg.cnt).map(p=>`<th>${D.cfg.avs[p-1]}<br>${D.cfg.names[p-1]}</th>`).join('')}</tr></thead><tbody>${[1,2,3,4,5,6,7,8,9].map(h=>`<tr class="${D.nph[h]?'bg-cyan-100':D.dch[h]?'bg-purple-100':''}"><td>${h}${D.nph[h]?' ğŸ¯':''}${D.dch[h]?' ğŸŒï¸':''}</td>${[1,2,3,4].slice(0,D.cfg.cnt).map(p=>{const pts=calc(h,p);return`<td class="clickable ${pts>0?'bg-green-100':pts<0?'bg-red-100':''}" onclick="D.hole=${h};D.player=${p};D.view='input';render()">${pts>0?'+':''}${pts}</td>`}).join('')}</tr>`).join('')}<tr class="bg-yellow-100"><td><b>OUT</b></td>${[1,2,3,4].slice(0,D.cfg.cnt).map(p=>{const t=tOut(p);return`<td><b>${t>0?'+':''}${t}</b></td>`}).join('')}</tr>${[10,11,12,13,14,15,16,17,18].map(h=>`<tr class="${D.nph[h]?'bg-cyan-100':D.dch[h]?'bg-purple-100':''}"><td>${h}${D.nph[h]?' ğŸ¯':''}${D.dch[h]?' ğŸŒï¸':''}</td>${[1,2,3,4].slice(0,D.cfg.cnt).map(p=>{const pts=calc(h,p);return`<td class="clickable ${pts>0?'bg-green-100':pts<0?'bg-red-100':''}" onclick="D.hole=${h};D.player=${p};D.view='input';render()">${pts>0?'+':''}${pts}</td>`}).join('')}</tr>`).join('')}<tr class="bg-yellow-100"><td><b>IN</b></td>${[1,2,3,4].slice(0,D.cfg.cnt).map(p=>{const t=tIn(p);return`<td><b>${t>0?'+':''}${t}</b></td>`}).join('')}</tr><tr class="bg-blue-100"><td><b>TOTAL</b></td>${[1,2,3,4].slice(0,D.cfg.cnt).map(p=>{const t=tAll(p);return`<td><b>${t>0?'+':''}${t}</b></td>`}).join('')}</tr></tbody></table></div></div>`}
function rSet(){return`<div class="container"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h2 style="margin:0">è¨­å®š</h2><button onclick="D.showHowToUse=true;render()" style="background:none;border:none;font-size:24px;cursor:pointer;padding:4px;color:#ef4444">â“</button></div>${D.user?`<div style="background:#f3f4f6;padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center"><div><p style="font-size:11px;color:#6b7280;margin-bottom:4px">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</p><p style="font-size:13px;font-weight:600;color:#1f2937">${D.user.email}</p></div><button onclick="handleLogout()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:6px;font-size:12px;cursor:pointer">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button></div>`:''}<div class="mb-6" style="background:#f0fdf4;padding:16px;border-radius:12px"><label class="label" style="margin-bottom:12px">ğŸ® ãƒ©ã‚¦ãƒ³ãƒ‰æ“ä½œ</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><button class="btn-primary" style="width:100%" onclick="newRound()">ğŸ†• æ–°è¦ä½œæˆ</button><button class="btn-primary" style="width:100%" onclick="D.showRoundIdInput=true;render()">ğŸ”— å‚åŠ </button><button class="btn-secondary" style="width:100%;grid-column:1/3" onclick="D.showRounds=true;render()">ğŸ“‚ ãƒ©ã‚¦ãƒ³ãƒ‰ç®¡ç†</button></div>${D.rid?`<div style="margin-top:12px;padding:12px;background:white;border-radius:8px"><p style="font-size:11px;color:#6b7280;margin-bottom:4px">ç¾åœ¨ã®ãƒ©ã‚¦ãƒ³ãƒ‰ID</p><p style="font-size:10px;font-family:monospace;color:#16a34a;word-break:break-all">${D.rid}</p></div>`:''}</div><div class="mb-6"><label class="label">ã‚´ãƒ«ãƒ•å ´å</label><input class="input-full" value="${D.cfg.courseName}" oninput="D.cfg.courseName=this.value;save()"></div><div class="mb-6"><label class="label">ãƒ©ã‚¦ãƒ³ãƒ‰æ—¥</label><input type="date" class="input-full" value="${D.cfg.date}" onchange="D.cfg.date=this.value;save();render()"></div><div class="mb-6"><label class="label">äººæ•°</label><div class="flex flex-gap">${[2,3,4].map(n=>`<button class="btn btn-count ${D.cfg.cnt===n?'active':''}" onclick="D.cfg.cnt=${n};save();render()">${n}äºº</button>`).join('')}</div></div><div class="mb-6"><label class="label">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label><div class="space-y">${[0,1,2,3].slice(0,D.cfg.cnt).map(i=>`<div class="flex flex-gap"><button class="btn" style="font-size:24px;min-width:60px;padding:12px" onclick="openAvatarPicker(${i})">${D.cfg.avs[i]}</button><input class="input-full" value="${D.cfg.names[i]}" oninput="D.cfg.names[${i}]=this.value;save()"></div>`).join('')}</div></div><div class="mb-6" style="background:#fef3c7;padding:16px;border-radius:12px"><label class="label" style="margin-bottom:12px">ğŸ” ã‚­ãƒ£ãƒªãƒ¼ã‚ªãƒ¼ãƒãƒ¼</label><p style="font-size:12px;color:#92400e;margin-bottom:12px">è©²å½“è€…ãªã—ã®å›æ•°åˆ†ã‚’ç´¯ç©ã—ã€æ¬¡ã«å–ã£ãŸäººãŒå…¨ã¦ç²å¾—ã—ã¾ã™ï¼ˆOUT/INç‹¬ç«‹ï¼‰</p><div class="space-y" style="gap:8px"><label style="display:flex;align-items:center;gap:8px;padding:8px;background:white;border-radius:8px"><input type="checkbox" ${D.cfg.nikaiNearpin?'checked':''} onchange="D.cfg.nikaiNearpin=this.checked;save();render()" style="width:20px;height:20px"><span>ãƒ‹ã‚¢ãƒ”ãƒ³ ã‚­ãƒ£ãƒªãƒ¼ã‚ªãƒ¼ãƒãƒ¼</span></label><label style="display:flex;align-items:center;gap:8px;padding:8px;background:white;border-radius:8px"><input type="checkbox" ${D.cfg.nikaiDracon?'checked':''} onchange="D.cfg.nikaiDracon=this.checked;save();render()" style="width:20px;height:20px"><span>ãƒ‰ãƒ©ã‚³ãƒ³ ã‚­ãƒ£ãƒªãƒ¼ã‚ªãƒ¼ãƒãƒ¼</span></label></div></div><div class="mb-6" style="background:#cffafe;padding:16px;border-radius:12px"><label class="label" style="margin-bottom:12px">ğŸ¯ ãƒ‹ã‚¢ãƒ”ãƒ³ãƒ›ãƒ¼ãƒ«</label><div class="hole-scroll"><div class="hole-row">${[1,2,3,4,5,6,7,8,9].map(h=>`<button class="btn btn-hole" onclick="D.nph[${h}]=!D.nph[${h}];if(D.nph[${h}])D.dch[${h}]=false;save();render()" style="background:${D.nph[h]?'#06b6d4':'#f3f4f6'};color:${D.nph[h]?'white':'inherit'}">${h}</button>`).join('')}</div></div><div class="hole-scroll" style="margin-top:8px"><div class="hole-row">${[10,11,12,13,14,15,16,17,18].map(h=>`<button class="btn btn-hole" onclick="D.nph[${h}]=!D.nph[${h}];if(D.nph[${h}])D.dch[${h}]=false;save();render()" style="background:${D.nph[h]?'#06b6d4':'#f3f4f6'};color:${D.nph[h]?'white':'inherit'}">${h}</button>`).join('')}</div></div></div><div class="mb-6" style="background:#f3e8ff;padding:16px;border-radius:12px"><label class="label" style="margin-bottom:12px">ğŸŒï¸ ãƒ‰ãƒ©ã‚³ãƒ³ãƒ›ãƒ¼ãƒ«</label><div class="hole-scroll"><div class="hole-row">${[1,2,3,4,5,6,7,8,9].map(h=>`<button class="btn btn-hole" onclick="D.dch[${h}]=!D.dch[${h}];if(D.dch[${h}])D.nph[${h}]=false;save();render()" style="background:${D.dch[h]?'#a855f7':'#f3f4f6'};color:${D.dch[h]?'white':'inherit'}">${h}</button>`).join('')}</div></div><div class="hole-scroll" style="margin-top:8px"><div class="hole-row">${[10,11,12,13,14,15,16,17,18].map(h=>`<button class="btn btn-hole" onclick="D.dch[${h}]=!D.dch[${h}];if(D.dch[${h}])D.nph[${h}]=false;save();render()" style="background:${D.dch[h]?'#a855f7':'#f3f4f6'};color:${D.dch[h]?'white':'inherit'}">${h}</button>`).join('')}</div></div></div><div class="mb-6"><label class="label">ãƒ—ãƒªã‚»ãƒƒãƒˆ</label><div class="flex flex-gap"><button class="btn-primary" onclick="D.showPresets=true;render()">ğŸ“‚ èª­è¾¼</button><button class="btn-secondary" onclick="savePreset()">ğŸ’¾ ä¿å­˜</button></div></div><div class="bg-gray-50 mb-6"><h2>ç‚¹æ•°</h2><div class="space-y">${T.filter(t=>t.id!=='none').map(t=>`<div class="flex flex-gap" style="align-items:center"><div class="btn ${t.c}" style="min-width:100px;color:white;font-size:14px">${t.l}</div><input type="number" class="btn" style="width:70px;text-align:center" value="${D.cfg.pts[t.id]}" onchange="D.cfg.pts['${t.id}']=parseInt(this.value)||0;save()"><span>pt</span></div>`).join('')}</div></div><button class="btn-reset" onclick="D.scores={};D.nph={};D.dch={};save();alert('âœ… ãƒªã‚»ãƒƒãƒˆå®Œäº†')">ğŸ—‘ ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ</button></div></div>`}
function rPresets(){const list=JSON.parse(localStorage.getItem('plist')||'[]');return`<div class="modal" onclick="if(event.target===this){D.showPresets=false;render()}"><div class="modal-content" onclick="event.stopPropagation()"><h2>ğŸŒï¸ ãƒ—ãƒªã‚»ãƒƒãƒˆ</h2><div style="max-height:55vh;overflow-y:auto;margin:20px 0">${list.length===0?'<p style="color:#6b7280;padding:40px 20px;text-align:center">ãƒ‡ãƒ¼ã‚¿ãªã—</p>':''}${list.map(p=>`<div class="preset-item"><div class="preset-name">${p.name}</div><div class="preset-btns"><button class="btn-load" onclick="event.stopPropagation();loadP('${p.id}')">ğŸ“¥ èª­è¾¼</button><button class="btn-del" onclick="event.stopPropagation();delP('${p.id}')">ğŸ—‘</button></div></div>`).join('')}</div><button class="btn-secondary" style="width:100%" onclick="D.showPresets=false;render()">âœ–ï¸ é–‰ã˜ã‚‹</button></div></div>`}
function rSaveForm(){const name=D.cfg.courseName||'æœªè¨­å®š';const date=D.cfg.date.replace(/-/g,'/');const presetName=name+' '+date;return`<div class="modal" onclick="if(event.target===this){D.showSaveForm=false;render()}"><div class="modal-content" onclick="event.stopPropagation()"><h2>ğŸ’¾ ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜</h2><div style="margin:20px 0;padding:20px;background:#f3f4f6;border-radius:12px;text-align:center"><p style="color:#6b7280;margin-bottom:8px;font-size:14px">ä¿å­˜ã™ã‚‹è¨­å®šå</p><p style="font-size:18px;font-weight:bold">${presetName}</p></div><div style="display:flex;gap:12px"><button class="btn-secondary" style="flex:1" onclick="D.showSaveForm=false;render()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn-primary" style="flex:1" onclick="savePresetSubmit()">ä¿å­˜</button></div></div></div>`}
function rRounds(){const list=JSON.parse(localStorage.getItem('rounds_list')||'[]');return`<div class="modal" onclick="if(event.target===this){D.showRounds=false;render()}"><div class="modal-content" onclick="event.stopPropagation()"><h2>ğŸ“‚ ãƒ©ã‚¦ãƒ³ãƒ‰ç®¡ç†</h2><div style="max-height:55vh;overflow-y:auto;margin:20px 0">${list.length===0?'<p style="color:#6b7280;padding:40px 20px;text-align:center">ãƒ‡ãƒ¼ã‚¿ãªã—</p>':''}${list.map(r=>`<div class="preset-item" style="border-left:4px solid ${r.isJoined?'#2563eb':'#22c55e'}"><div class="preset-name" style="color:${r.isJoined?'#2563eb':'inherit'}">${r.isJoined?'ğŸ”— ':'ğŸ“ '}${r.courseName} (${r.date})</div><div class="preset-btns"><button class="btn-load" onclick="event.stopPropagation();loadRound('${r.id}');D.showRounds=false">ğŸ“¥ èª­è¾¼</button><button class="btn-del" onclick="event.stopPropagation();deleteRound('${r.id}')">ğŸ—‘</button></div></div>`).join('')}</div><div style="padding:12px;background:#f0f9ff;border-radius:8px;margin-bottom:16px"><p style="font-size:12px;color:#0369a1"><strong>ğŸ”— é’è‰²ï¼š</strong>å‚åŠ ã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆä»–ã®äººãŒä½œæˆï¼‰</p><p style="font-size:12px;color:#0369a1;margin-top:4px"><strong>ğŸ“ ç·‘è‰²ï¼š</strong>è‡ªåˆ†ã§ä½œæˆã—ãŸãƒ©ã‚¦ãƒ³ãƒ‰</p></div><div style="display:flex;gap:12px">${D.adminMode?'<button class="btn-secondary" style="flex:1" onclick="D.showFirebaseManager=true;D.showRounds=false;loadFirebaseRounds()">â˜ï¸ Firebaseç®¡ç†</button>':''}${D.adminMode?'<button class="btn-secondary" style="flex:1" onclick="D.showUserManager=true;D.showRounds=false;loadAllUsers()">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>':''}<button class="btn-secondary" style="flex:1" onclick="D.showRounds=false;render()">âœ–ï¸ é–‰ã˜ã‚‹</button></div></div></div>`}
function rFirebaseManager(){return`<div class="modal" onclick="if(event.target===this){D.showFirebaseManager=false;render()}"><div class="modal-content" onclick="event.stopPropagation()"><h2>â˜ï¸ Firebaseç®¡ç†</h2><div style="background:#dcfce7;padding:8px;border-radius:8px;margin-bottom:12px;text-align:center"><p style="font-size:11px;color:#166534;font-weight:bold">ğŸ”“ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</p></div><div style="max-height:55vh;overflow-y:auto;margin:20px 0">${D.firebaseRounds.length===0?'<p style="color:#6b7280;padding:40px 20px;text-align:center">ãƒ‡ãƒ¼ã‚¿ãªã—</p>':''}${D.firebaseRounds.map(r=>`<div class="preset-item"><div class="preset-name">${r.courseName}<div style="font-size:11px;color:#6b7280;margin-top:4px">${r.date} | ${r.playerCount}äºº | ${new Date(r.updatedAt).toLocaleString('ja-JP')}</div><div style="font-size:10px;font-family:monospace;color:#9ca3af;margin-top:4px">${r.id}</div></div><div class="preset-btns"><button class="btn-del" onclick="event.stopPropagation();deleteFirebaseRound('${r.id}')">ğŸ—‘ å‰Šé™¤</button></div></div>`).join('')}</div><div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px"><p style="font-size:12px;color:#92400e">âš ï¸ ã“ã“ã‹ã‚‰å‰Šé™¤ã™ã‚‹ã¨ã€Firebaseã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚å‚åŠ è€…å…¨å“¡ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚</p></div><div style="display:flex;gap:12px"><button class="btn-secondary" style="flex:1" onclick="loadFirebaseRounds()">ğŸ”„ æ›´æ–°</button><button class="btn-secondary" style="flex:1" onclick="D.showFirebaseManager=false;render()">âœ–ï¸ é–‰ã˜ã‚‹</button></div></div></div>`}
function rUserManager(){return`<div class="modal" onclick="if(event.target===this){D.showUserManager=false;render()}"><div class="modal-content" onclick="event.stopPropagation()"><h2>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‰¿èªç®¡ç†</h2><div style="background:#dcfce7;padding:8px;border-radius:8px;margin-bottom:12px;text-align:center"><p style="font-size:11px;color:#166534;font-weight:bold">ğŸ”“ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</p></div><div style="max-height:55vh;overflow-y:auto;margin:20px 0">${D.userList.length===0?'<p style="color:#6b7280;padding:40px 20px;text-align:center">èª­è¾¼ä¸­...</p>':''}${D.userList.map(u=>`<div class="preset-item" style="border-left:4px solid ${u.isAdmin?'#8b5cf6':u.authorized?'#22c55e':'#f59e0b'}"><div class="preset-name">${u.isAdmin?'ğŸ‘‘':u.authorized?'âœ…':'â³'} ${u.email}${u.isAdmin?' <span style="background:#8b5cf6;color:white;font-size:10px;padding:2px 6px;border-radius:4px;margin-left:4px">ç®¡ç†è€…</span>':''}<div style="font-size:11px;color:#6b7280;margin-top:4px">UID: ${u.uid}</div>${u.addedAt?`<div style="font-size:10px;color:#9ca3af;margin-top:2px">${new Date(u.addedAt).toLocaleString('ja-JP')}</div>`:''}</div><div class="preset-btns" style="display:flex;flex-direction:column;gap:4px">${u.authorized?`<button class="btn-del" onclick="event.stopPropagation();revokeUser('${u.uid}','${u.email}')" style="font-size:11px;padding:6px 8px">âŒ å´ä¸‹</button>`:`<button class="btn-load" onclick="event.stopPropagation();approveUser('${u.uid}','${u.email}')" style="font-size:11px;padding:6px 8px">âœ… æ‰¿èª</button>`}${u.authorized?(u.isAdmin?`<button class="btn-secondary" onclick="event.stopPropagation();removeAdmin('${u.uid}','${u.email}')" style="font-size:11px;padding:6px 8px;background:#8b5cf6;color:white">ğŸ‘¤ ç®¡ç†è€…è§£é™¤</button>`:`<button class="btn-secondary" onclick="event.stopPropagation();makeAdmin('${u.uid}','${u.email}')" style="font-size:11px;padding:6px 8px;background:#8b5cf6;color:white">ğŸ‘‘ ç®¡ç†è€…ã«ã™ã‚‹</button>`):''}${!u.authorized?`<button class="btn-del" onclick="event.stopPropagation();removeUser('${u.uid}','${u.email}')" style="font-size:11px;padding:6px 8px">ğŸ—‘ å‰Šé™¤</button>`:''}</div></div>`).join('')}</div><div style="background:#e0f2fe;padding:12px;border-radius:8px;margin-bottom:16px"><p style="font-size:12px;color:#0369a1"><strong>ğŸ‘‘ ç®¡ç†è€…ï¼š</strong>å…¨æ©Ÿèƒ½+ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãŒå¯èƒ½</p><p style="font-size:12px;color:#0369a1;margin-top:4px"><strong>âœ… æ‰¿èªæ¸ˆã¿ï¼š</strong>ã‚¹ã‚³ã‚¢å…¥åŠ›ãƒ»ãƒ©ã‚¦ãƒ³ãƒ‰ä½œæˆãŒå¯èƒ½</p><p style="font-size:12px;color:#0369a1;margin-top:4px"><strong>â³ æœªæ‰¿èªï¼š</strong>é–²è¦§ãƒ»å‚åŠ ã®ã¿å¯èƒ½</p></div><div style="display:flex;gap:12px"><button class="btn-secondary" style="flex:1" onclick="loadAllUsers()">ğŸ”„ æ›´æ–°</button><button class="btn-secondary" style="flex:1" onclick="D.showUserManager=false;render()">âœ–ï¸ é–‰ã˜ã‚‹</button></div></div></div>`}
function rRoundIdInput(){return`<div class="modal" onclick="if(event.target===this){D.showRoundIdInput=false;render()}"><div class="modal-content" onclick="event.stopPropagation()"><h2>ğŸ”— ãƒ©ã‚¦ãƒ³ãƒ‰ã«å‚åŠ </h2><div style="margin:20px 0"><p style="font-size:13px;color:#6b7280;margin-bottom:12px">ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‹ã‚‰å…±æœ‰ã•ã‚ŒãŸãƒ©ã‚¦ãƒ³ãƒ‰IDã‚’å…¥åŠ›</p><input id="roundIdInput" class="input-full" placeholder="round_1234567890123" style="font-size:14px;font-family:monospace"></div><div style="background:#e0f2fe;padding:12px;border-radius:8px;margin-bottom:16px"><p style="font-size:12px;color:#0369a1">ğŸ’¡ åŒã˜ãƒ©ã‚¦ãƒ³ãƒ‰IDã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å…¨å“¡ãŒåŒã˜ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ã‚’å…±æœ‰ã§ãã¾ã™</p></div>${D.debugLog.length>0?`<div style="background:#f3f4f6;padding:8px;border-radius:8px;margin-bottom:16px;max-height:150px;overflow-y:auto"><p style="font-size:10px;font-weight:bold;margin-bottom:4px">ğŸ“‹ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</p>${D.debugLog.map(l=>`<p style="font-size:10px;font-family:monospace;margin:2px 0">${l}</p>`).join('')}</div>`:''}<div style="display:flex;gap:12px"><button class="btn-secondary" style="flex:1" onclick="D.showRoundIdInput=false;render()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn-primary" style="flex:1" onclick="joinRound()">å‚åŠ </button></div></div></div>`}
function render(){
  // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆæœªãƒ­ã‚°ã‚¤ãƒ³ã®ã¿ãƒ–ãƒ­ãƒƒã‚¯ï¼‰
  if(!D.isAuthenticated){
    document.getElementById('app').innerHTML = rLogin();
    return;
  }
  const v={input:rInput,list:rList,settings:rSet};let h=v[D.view]();if(D.showPresets)h+=rPresets();if(D.showSaveForm)h+=rSaveForm();if(D.showRounds)h+=rRounds();if(D.showRoundIdInput)h+=rRoundIdInput();if(D.showAvatarPicker)h+=rAvatarPicker();if(D.showFirebaseManager)h+=rFirebaseManager();if(D.showUserManager)h+=rUserManager();if(D.showHowToUse)h+=rHowToUse();if(D.alert)h+=`<div class="alert">${D.alert}</div>`;h+=`<div class="nav"><button class="nav-btn ${D.view==='input'?'active':''}" onclick="D.view='input';render()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg><span>å…¥åŠ›</span></button><button class="nav-btn ${D.view==='list'?'active':''}" onclick="D.view='list';render()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg><span>ä¸€è¦§</span></button><button class="nav-btn ${D.view==='settings'?'active':''}" onclick="D.view='settings';render()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg><span>è¨­å®š</span></button></div>`;document.getElementById('app').innerHTML=h}
// èªè¨¼é–¢æ•°
// èªè¨¼é–¢æ•°
async function handleGoogleLogin(){
  try{
    const result = await window.auth.signInWithPopup(window.googleProvider);
    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user.email);
  }catch(error){
    console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}
async function handleLogout(){
  try{
    await window.auth.signOut();
    D.user = null;
    D.isAuthenticated = false;
    D.isAuthorized = false;
    D.adminMode = false;
    render();
    console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
  }catch(error){
    console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
  }
}
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è‡ªå‹•ç™»éŒ²ï¼ˆåˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼‰
async function ensureUserRegistered(user){
  try{
    const userRef = window.database.ref(`authorized_users/${user.uid}`);
    const snapshot = await userRef.once('value');
    
    if(!snapshot.exists()){
      // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ï¼šæœªæ‰¿èªçŠ¶æ…‹ã§ç™»éŒ²
      await userRef.set({
        email: user.email,
        authorized: false,
        addedAt: Date.now()
      });
      console.log('ğŸ“ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²:', user.email);
    }
  }catch(error){
    console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
  }
}
async function checkUserAuthorization(user){
  try{
    const userRef = window.database.ref(`authorized_users/${user.uid}`);
    const snapshot = await userRef.once('value');
    console.log('ğŸ” æ‰¿èªãƒã‚§ãƒƒã‚¯ - UID:', user.uid);
    console.log('ğŸ” Snapshot exists:', snapshot.exists());
    
    if(snapshot.exists()){
      const userData = snapshot.val();
      console.log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿:', userData);
      D.isAuthorized = userData.authorized === true;
      D.adminMode = userData.isAdmin === true; // ç®¡ç†è€…ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
      console.log('ğŸ” isAuthorized:', D.isAuthorized);
      console.log('ğŸ” adminMode:', D.adminMode);
      
      if(D.isAuthorized){
        console.log('âœ… æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.email, D.adminMode ? '(ç®¡ç†è€…)' : '');
      }else{
        console.log('âš ï¸  æœªæ‰¿èªãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆé–²è¦§å°‚ç”¨ï¼‰:', user.email);
      }
    }else{
      D.isAuthorized = false;
      D.adminMode = false;
      console.log('âš ï¸  æœªæ‰¿èªãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆé–²è¦§å°‚ç”¨ï¼‰:', user.email);
    }
  }catch(error){
    // æ‰¿èªãƒªã‚¹ãƒˆã«å­˜åœ¨ã—ãªã„å ´åˆï¼ˆé–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰
    D.isAuthorized = false;
    D.adminMode = false;
    console.log('â„¹ï¸  é–²è¦§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰:', user.email);
    console.error('æ‰¿èªãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
  }
  render();
}
function init(){
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
  const urlParams = new URLSearchParams(window.location.search);
  const adminParam = urlParams.get('admin');
  
  if(adminParam){
    const savedPassword = localStorage.getItem('admin_password');
    
    // åˆå›ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
    if(!savedPassword){
      const newPassword = prompt('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š');
      if(newPassword){
        localStorage.setItem('admin_password', newPassword);
        D.adminMode = true;
        log('âœ… ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ONï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šæ¸ˆã¿ï¼‰');
      }
    } else {
      // 2å›ç›®ä»¥é™ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
      const inputPassword = prompt('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š');
      if(inputPassword === savedPassword){
        D.adminMode = true;
        log('âœ… ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ON');
      } else {
        alert('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
      }
    }
  }
  
  // æœ€å¾Œã«ä½¿ã£ãŸãƒ©ã‚¦ãƒ³ãƒ‰ãŒã‚ã‚Œã°å¾©å…ƒ
  const lastRid = localStorage.getItem('last_round_id');
  if(lastRid){
    const r=JSON.parse(localStorage.getItem(lastRid));
    if(r){
      log('å‰å›ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¾©å…ƒ: ' + lastRid);
      D.rid=lastRid;
      D.scores=r.scores||{};
      if(r.cfg){D.cfg=r.cfg}
      if(r.nph){D.nph=r.nph}
      if(r.dch){D.dch=r.dch}
      const list=JSON.parse(localStorage.getItem('rounds_list')||'[]');
      const roundInfo=list.find(x=>x.id===lastRid);
      D.isJoinedRound=roundInfo&&roundInfo.isJoined?true:false;
    }
  }
  D.view='settings';
  render();
  // Service Workerç™»éŒ²ï¼ˆsw.jsãŒå­˜åœ¨ã™ã‚‹ç’°å¢ƒã®ã¿ï¼‰
  if('serviceWorker' in navigator && !window.location.hostname.includes('claudusercontent')){
    navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registered')).catch(e=>console.log('SW registration skipped (not supported in this environment)'))
  }
}
// ãƒ—ãƒ«ãƒˆã‚¥ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æ©Ÿèƒ½
let pullStartY=0;
let pulling=false;
const indicator=document.createElement('div');
indicator.className='pull-indicator';
indicator.textContent='ğŸ”„ å¼•ã£å¼µã£ã¦æ›´æ–°';
document.body.appendChild(indicator);
document.addEventListener('touchstart',e=>{
  if(window.scrollY===0){
    pullStartY=e.touches[0].clientY;
    pulling=true;
  }
},{ passive:true });
document.addEventListener('touchmove',e=>{
  if(!pulling)return;
  const currentY=e.touches[0].clientY;
  const pullDistance=currentY-pullStartY;
  if(pullDistance>80){
    indicator.classList.add('active');
  }else{
    indicator.classList.remove('active');
  }
  if(pullDistance>150&&window.scrollY===0){
    pulling=false;
    indicator.textContent='ğŸ”„ æ›´æ–°ä¸­...';
    setTimeout(()=>location.reload(),300);
  }
},{ passive:true });
document.addEventListener('touchend',()=>{
  pulling=false;
  indicator.classList.remove('active');
  indicator.textContent='ğŸ”„ å¼•ã£å¼µã£ã¦æ›´æ–°';
},{ passive:true });
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«åˆæœŸåŒ–
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',init);
}else{
  init();
}
</script>
</body>
</html>
